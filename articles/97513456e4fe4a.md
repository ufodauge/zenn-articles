---
title: "useSyncExternalStore ã®æŒ™å‹•ã¸ã®èª¤è§£"
emoji: "ğŸ§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["React", "NodeCG"]
published: true
---

`useSyncExternalStore` ã®æŒ™å‹•ã‚’èª¤è§£ã—ã¦ã„ãŸãŸã‚ã«å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã†ã¾ãæ‰±ãˆã¦ã„ãªã‹ã£ãŸã®ã§ã€è¦šæ›¸ãŒã¦ã‚‰ç°¡æ½”ã«ã€‚

## è¨€ã„ãŸã„ã“ã¨

- `useSyncExternalStore(subscribe, getSnapshot)` ã¯ `getSnapshot` ãŒæ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™ã¨ãã®ã¿æ›´æ–°ã•ã‚Œã€`getSnapshot` ã¯ `subscribe` é–¢æ•°å†…ã§è³¼èª­ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç™ºç«ã•ã‚Œã‚‹ã€‚
- ã™ãªã‚ã¡ã€ `subscribe` é–¢æ•°å†…ã«å†ãƒ¬ãƒ³ãƒ€ãƒ¼ã•ã›ãŸã„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜è¿°ã™ã‚‹ã ã‘ã§ã¯å†ãƒ¬ãƒ³ãƒ€ãƒ¼ã•ã‚Œãªã„å ´åˆãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã€‚

## `useSyncExternalStore` ã®ç”¨é€”ãƒ»ä½¿ç”¨æ–¹æ³•

- å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ä½œæˆã‚’è£œåŠ©ã™ã‚‹ React ã®ãƒ•ãƒƒã‚¯ (v18^)
- åŒæ§˜ã®ã“ã¨ã¯ä»Šã¾ã§ã‚‚ `useState` ã¨ `useEffect` ã‚’ç”¨ã„ã¦ã§ãã¦ã„ãŸãŒã€ã“ã‚Œã«ã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ã«æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã£ãŸ

```ts
// https://ja.react.dev/reference/react/useSyncExternalStore#subscribing-to-a-browser-api
import { useSyncExternalStore } from "react";

// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‹ã©ã†ã‹ã‚’è¿”ã™ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
export function useIsOnline() {
  return useSyncExternalStore(subscribe, getSnapshot);
}

// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’è¿”ã™ã ã‘ã®é–¢æ•°
function getSnapshot() {
  // navigator.onLine: ãƒ–ãƒ©ã‚¦ã‚¶ãƒ¼ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‹ã©ã†ã‹ã‚’è¿”ã™
  return navigator.onLine;
}

// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ»ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®å¤‰åŒ–ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­ã™ã‚‹ãŸã‚ã®é–¢æ•°
// è³¼èª­ã‚’è§£é™¤ã™ã‚‹é–¢æ•°ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚‹
function subscribe(callback) {
  addEventListener("online", callback);
  addEventListener("offline", callback);

  return () => {
    removeEventListener("online", callback);
    removeEventListener("offline", callback);
  };
}
```

## çµŒç·¯

å…ˆã®ä¾‹ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ã€`navigator.connection` ã®ã‚ˆã†ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚‚ä¸€ç·’ã«è¿”ã—ãŸã„ã¨ã™ã‚‹ï¼š

```ts
function getSnapshot(): [boolean, Geolocation] {
  return [navigator.onLine, navigator.geolocation];
}
```

ã“ã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ï¼š

```
useIsOnline.ts:4 Warning: The result of getSnapshot should be cached to avoid an infinite loop Error Component Stack
    at App (App.tsx:9:29)
```

ã“ã‚Œã‚’å›é¿ã™ã‚‹ãŸã‚ã« snapshot ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ï¼ˆ[å‚è€ƒ](https://ja.react.dev/reference/react/useSyncExternalStore#im-getting-an-error-the-result-of-getsnapshot-should-be-cached)ï¼‰ï¼š

```ts
const cache: [boolean, Geolocation] = [navigator.onLine, navigator.geolocation];

function getSnapshot() {
  cache[0] = navigator.onLine;
  cache[1] = navigator.geolocation;

  return cache;
}
```

ã“ã†ã™ã‚‹ã¨ä»Šåº¦ã¯ online/offline ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«æ™‚ã« `useSyncExternalStore` ãŒå¤‰æ›´ã•ã‚ŒãŸå€¤ã‚’è¿”ã•ãªããªã‚‹ã€‚

## åŸå› 

`useSyncExternalStore` ã«æ¸¡ã™ `subscribe` é–¢æ•°ãŒå¼•æ•°ã«å—ã‘å–ã‚‹ callback ã¯ä»¥ä¸‹ã®æ§˜ã«ãªã£ã¦ã„ã‚‹ï¼š

```js
function subscribeToStore(fiber, inst, subscribe) {
  var handleStoreChange = function () {
    // The store changed. Check if the snapshot changed since the last time we
    // read from the store.
    if (checkIfSnapshotChanged(inst)) {
      // Force a re-render.
      forceStoreRerender(fiber);
    }
  }; // Subscribe to the store and return a clean-up function.

  return subscribe(handleStoreChange);
}
```

ã€Œè³¼èª­ã—ã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚Œã°ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å¼·åˆ¶ã™ã‚‹ã€ã¨ã„ã†æ–‡è„ˆãŒèª­ã¿å–ã‚Œã‚‹ã€‚

å…ˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŒ–ã®å®Ÿè£…ã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒåŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã—ã¦ã—ã¾ã†ã®ã§ã€è³¼èª­ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ã¦ã‚‚ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒå¤‰æ›´ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€`useSyncExternalStore` ãŒæ–°ã—ã„å€¤ã‚’è¿”ã•ãšã€å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚‚ç™ºç”Ÿã—ãªã„ã€‚

## è§£æ±ºç­–ã®ä¾‹

`navigator.onLine` ãŒå¤‰æ›´ã•ã‚ŒãŸéš›ã® `navigator.geolocation` ãŒæ¬²ã—ã„ã ã‘ãªã‚‰ **ãã‚‚ãã‚‚ã‚ã‚“ãªã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½œã‚‹å¿…è¦ã¯ãªã„**ã€‚

```ts
export function useIsOnline() {
  const isOnline = useSyncExternalStore(subscribe, getSnapshot);

  return [isOnline, navigator.geolocation];
}

function getSnapshot() {
  return navigator.onLine;
}

function subscribe(callback: () => void) {
  addEventListener("online", callback);
  addEventListener("offline", callback);

  return () => {
    removeEventListener("online", callback);
    removeEventListener("offline", callback);
  };
}
```

ãªã‚“ã«ã›ã‚ˆã€è‡ªåˆ†ãŒä½œæˆã—ãŸã„ãƒ•ãƒƒã‚¯ã®æ›´æ–°æ¡ä»¶ã‚’æ•´ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã€‚

--- 

ä»¥ä¸‹ã»ã¼ãŠã¾ã‘

## useReplicant ã‚’ä½œæˆã™ã‚‹ä¾‹

ã“ã®è¨˜äº‹ã¯ [NodeCG](https://www.nodecg.dev/) ã® `useReplicant` ã‚’è‡ªä½œã—ãŸéš›ã«å›°ã£ãŸãŸã‚ã®å‚™å¿˜éŒ²ã¨ã„ã†é¢ãŒã‚ã‚‹ãŸã‚ã€ä»¥ä¸‹ã«å®Ÿè£…ã¨è¦ç‚¹ã‚’è¨˜è¿°ã™ã‚‹ã€‚

```ts
import { useCallback, useMemo, useSyncExternalStore } from "react";
import { IReplicant } from "@/types/schemas";

const defaultValue: IReplicant = { ... };

type SetValueAction<T> = (newValue: T | ((old?: T) => T)) => void;
type ReturnType<TKey extends keyof IReplicant> = [
  IReplicant[TKey] | undefined,
  SetValueAction<IReplicant[TKey]>,
  {
    isLoaded: boolean;
  }
];

const DUMMY = Symbol();

export const useReplicant = <TKey extends keyof IReplicant>(
  key: TKey
): ReturnType<TKey> => {
  // replicant è‡ªä½“ã¯ãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªãã¦è‰¯ã„
  const replicant = useMemo(() => {
    return nodecg.Replicant<IReplicant[TKey]>(key, {
      defaultValue: defaultValue[key],
    });
  }, [key]);

  // replicant.status === "declared" ã«ãªã‚‹ã¨ DUMMY ã§ã¯ãªã replicant.value ã‚’è¿”ã™ã‚ˆã†ã«ãªã‚Šã€
  // getSnapshot() ã®è¿”ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå¤‰æ›´ã•ã‚ŒãŸåˆ¤å®šã«ãªã‚‹
  // -> å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒèµ°ã‚‹
  //
  // DUMMY ã§ã¯ãªã undefined ã ã¨ã€ replicant.value ãŒã‚‚ã¨ã‚‚ã¨ undefined ã ã£ãŸå ´åˆã«
  // getSnapshot() ã®è¿”ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ undefined ã®ã¾ã¾
  // -> å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒèµ°ã‚‰ãªã„
  const getSnapshot = () => {
    return replicant.status === "declared" ? replicant.value : DUMMY;
  };

  const subscribe = useCallback(
    (callback: () => void) => {
      replicant.on("change", callback);

      return () => {
        replicant.removeListener("change", callback);
      };
    },
    [replicant]
  );

  // DUMMY ã‚’ã‚ã–ã‚ã–æ¡ç”¨ã—ã¦ã„ã‚‹å¼Šå®³ãŒå‡ºã¦ã„ã‚‹
  const storedValue =
    useSyncExternalStore(subscribe, getSnapshot) === DUMMY
      ? undefined
      : replicant.value;
  const isLoaded = replicant.status === "declared";

  const setValue: SetValueAction<IReplicant[TKey]> = useCallback(
    (newValue) => {
      if (typeof newValue === "function") {
        replicant.value = newValue(storedValue);
      } else {
        replicant.value = newValue;
      }
    },
    [replicant, storedValue]
  );

  return [storedValue, setValue, { isLoaded }];
};
```

å¤§äº‹ãªç‚¹ã¯ã‚³ãƒ¡ãƒ³ãƒˆã«è¨˜è¿°ã—ã¦ã„ã‚‹ãŒã€

- `replicant.status === "declared"` ã«ãªã‚‹ã¨ `DUMMY` ã§ã¯ãªã `replicant.value` ã‚’è¿”ã™ã‚ˆã†ã«ãªã‚Šã€`getSnapshot()` ã®è¿”ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå¤‰æ›´ã•ã‚ŒãŸåˆ¤å®šã«ãªã‚‹
  - -> **å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒèµ°ã‚‹**
- `DUMMY` ã§ã¯ãªã `undefined` ã ã¨ã€ `replicant.value` ãŒã‚‚ã¨ã‚‚ã¨ `undefined` ã ã£ãŸå ´åˆã« `getSnapshot()` ã®è¿”ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒ `undefined` ã®ã¾ã¾
  - -> **å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãŒèµ°ã‚‰ãªã„**
- `const storedValue = ...` ã§ `DUMMY` ã‚’ã‚ã–ã‚ã–æ¡ç”¨ã—ã¦ã„ã‚‹å¼Šå®³ãŒå‡ºã¦ã„ã‚‹
  - å›ã‚Šãã©ã„ã ã‘ã§ã¯ã‚ã‚‹

`useEffect` ã¨ `useState` ã®çµ„ã¿åˆã‚ã›ã‚ˆã‚Šè¨˜è¿°é‡ãŒå¢—ãˆã‚‹ãŒã€æ¯”è¼ƒçš„ãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«æ›¸ã‘ã¦ã‚ã‹ã‚Šã‚„ã™ã„ï¼ˆå¤šåˆ†ï¼‰
