---
title: "google.scripts.run ã«ãŠã‘ã‚‹å¼•æ•°ã®åˆ¶ç´„"
emoji: "ğŸŒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GAS"]
published: true
---

## ä¾‹

```js:code.gs
function myFunction(param) {
  console.log(param);

  return {
    ok: true,
    value: {
      fruit: "banana",
      count: 10,
    },
    date: new Date(),
  }
}
```

```js:index.html
<script>
  function onSuccess(result) {
    console.log(result);
    // > null
  }

  const param = {
    ok: true,
    value: {
      fruit: "banana",
      count: 10,
    },
    // func: () => console.log("ok"),
    //       ^^^^^^^^^^^^^^^^^^^^^^^
    // Uncaught TypeError: Failed due to illegal value in property: func
  }

  google.script.run
    .withSuccessHandler(onSuccess)
    .myFunction(param)
</script>
```

## ãªãœã“ã®ã‚ˆã†ãªã“ã¨ãŒèµ·ã“ã‚‹ã‹

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ <-> ã‚µãƒ¼ãƒãƒ¼ã®é€šä¿¡ã§ã¯ã€é–¢æ•°ã®ä»–ã€Date ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã©ã‚’æ¸¡ã›ãªã„ã€‚
https://developers.google.com/apps-script/guides/html/reference/run

ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ -> ã‚µãƒ¼ãƒãƒ¼ã€ã§ã¯ã€`Uncaught TypeError: Failed due to illegal value in property: {property name}` ãŒç™ºç”Ÿã™ã‚‹ã€‚

ã€Œã‚µãƒ¼ãƒãƒ¼ -> ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã€ã§ã¯ã€æˆåŠŸåˆ¤å®šã®ä¸Šã§æ¸¡ã•ã‚Œã‚‹å€¤ãŒ `null` ã«ãªã‚‹ã€‚

## æš«å®šçš„ãªè§£æ±ºç­–

ä»¥ä¸‹ã§ã¯ `clasp` ã‚’ç”¨ã„ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«é–‹ç™ºç’°å¢ƒã‚’ç§»ã—ã€TypeScript x React ã§é–‹ç™ºã‚’ã—ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒª [gas-client](https://github.com/enuchi/gas-client) ã‚’ç”¨ã„ã‚‹å‰æã¨ã™ã‚‹ï¼ˆå‹æ‰‹ã«é£›èºã—ã¦ã™ã¿ã¾ã›ã‚“ï¼‰ã€‚
https://zenn.dev/hasehiro0828/articles/3eb9cb46527e02

:::details result.ts
```ts:result.ts
type Result<T, E extends Error = Error> = Success<T> | Failure<E>;

class Success<T> {
  readonly value: T;

  constructor(value: T) {
    this.value = value;
  }
  isOk(): this is Success<T> {
    return true;
  }
  isErr(): this is Failure<never> {
    return false;
  }
}

class Failure<E extends Error> {
  readonly error: E;

  constructor(error: E) {
    this.error = error;
  }
  isOk(): this is Success<unknown> {
    return false;
  }
  isErr(): this is Failure<E> {
    return true;
  }
}

function Ok<T>(value: T) {
  return new Success(value);
}

function Err<E extends Error>(err: E) {
  return new Failure(err);
}
```
:::

```ts:ã‚µãƒ¼ãƒãƒ¼å´ã®é©å½“ãªé–¢æ•°
type MyType = {
  ok: boolean;
  value: {
    fruit: string;
    count: number;
    nested: {
      hoge: boolean;
      fuga: (number | number[])[];
    };
  };
};

function myFunction(param: MyType, param2: string): Result<MyType> {
  console.log(param, param2);

  return Ok({
    ok: true,
    value: {
      fruit: "banana",
      count: 10,
      nested: {
        hoge: true,
        fuga: [0.1, 2, [3, 4]],
      },
    },
  });
}
```

```ts:gas-client ã« api ã¨ã—ã¦èªè­˜ã•ã›ã‚‹éƒ¨åˆ†
type ApiData =
  | string
  | number
  | boolean
  | undefined
  | null
  | { [key: number]: ApiData }
  | { [key: string]: ApiData }
  | ApiData[]
  | HTMLFormElement;

type ApiResult<T extends ApiData> =
  | {
      ok: true;
      data: T;
    }
  | {
      ok: false;
      name: string;
      message: string;
    };

function apiHandler<T extends ApiData>(
  proc: () => Result<T>
): ApiResult<T> {
  const result = proc();

  if (result.isOk()) {
    return {
      ok: true,
      data: result.value,
    };
  }

  return {
    ok: false,
    name: result.error.name,
    message: result.error.message,
  };
}

export function apiMyFunction(...p: Parameters<typeof myFunction>) {
  return apiHandler(() => myFunction(...p));
}
```

```tsx:ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´
import { GASClient } from "gas-client";
import * as server from "../server/main";
const { serverFunctions } = new GASClient<typeof server>();

function App() {
  const param = {
    ok: true,
    value: {
      fruit: "banana",
      count: 10,
      nested: {
        hoge: true,
        fuga: [0.1, 2, [3, 4]],
      },
    },
  };

  serverFunctions.apiMyFunction(param, "param2").then((v) => {
    console.log(v);
  });

  return <></>;
}

export default App;
```

### è§£æ±ºã—ãŸã“ã¨

- ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®è¿”ã‚Šå€¤ã‚’åˆ¶é™ã§ããŸ

### è§£æ±ºã—ã¦ãªã„ã“ã¨

- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰æ¸¡ã™å¼•æ•°ã®å‹ã‚’åˆ¶é™ã§ãã¦ã„ãªã„
  - GAS ã®åˆ¶é™ã«ã‚ˆã‚Š `export const` ãŒå‡ºæ¥ãªã„ãŸã‚
  - ä»»æ„ã®å¼•æ•°ã®å‹ã‚’å—ã‘å–ã‚‹é–¢æ•°ãŒä½œæˆã§ããªã„ãŸã‚

è‰¯ã„æ–¹æ³•ã‚ã£ãŸã‚‰æ•™ãˆã¦ãã ã•ã„ã€‚
